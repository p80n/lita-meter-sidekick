#cloud-config

write_files:
  - path: "/opt/bin/meterctl"
    permissions: "0755"
    owner: "root"
    encoding: "base64"
    content: |
      <%= @meterctl %>
  - path: "/root/install-meter"
    permissions: "0755"
    owner: "root"
    content: |
      #!/bin/sh
      HOSTNAME=$(curl http://instance-data/latest/meta-data/public-hostname)
      PUBLIC_IP=$(curl http://instance-data/latest/meta-data/public-ipv4)
      PRIVATE_IP=$(curl http://instance-data/latest/meta-data/local-ipv4)
      END_USER_LICENSE_ACCEPTED=yes
      /opt/bin/meterctl install-master -f $HOSTNAME -P $PUBLIC_IP -p $PRIVATE_IP
