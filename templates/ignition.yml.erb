ignition:
  version: "2.1.0"
storage:
  files:
    - filesystem: root,
      path: /root/meterctl-init
      mode: 755
      contents: |
        #!/bin/bash
        END_USER_LICENSE_ACCEPTED=yes
        /opt/bin/meterctl install-master -f $(curl http://instance-data/latest/meta-data/public-hostname) -P $(curl http://instance-data/latest/meta-data/public-ipv4) -p $(curl http://instance-data/latest/meta-data/local-ipv4)

        echo begin kubeconfig
        sudo sed -r 's|(^.+-authority): (.+)|printf "\1-data: %s" $(base64 -w0 \2)|e; s|(^.+-certificate: )(.+)|printf "    client-certificate-data: %s" $(base64 -w0 \2)|e;   s|(^ *client-key: )(.+)|printf "    client-key-data: %s" $(base64 -w0 \2)|e;'   /root/.kube/config >> /dev/console
        echo end kubeconfig

    - filesystem: root
      path: /opt/bin/meterctl
      mode: 755
      contents:
        source: https://s3.amazonaws.com/6fusion-meter-dev/coreos/<%= @version %>/meterctl
systemd:
  units:
  - name: meterctl-init.service
    enabled: true
    contents: |
      [Service]
      Type=oneshot
      ExecStart=/root/meterctl-init
      KillMode=process
      [Install]
      WantedBy=network-online.target




