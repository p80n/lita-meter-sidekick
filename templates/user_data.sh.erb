#!/bin/bash

curl -o /opt/bin/amazon-ssm-agent https://s3.amazonaws.com/6fusion-dev-jenkins/amazon-ssm-agent

cat <<EOF > /etc/systemd/system/amazon-ssm-agent.service
[Unit]
Description=amazon-ssm-agent
[Service]
Type=simple
WorkingDirectory=/opt/bin
ExecStart=/opt/bin/amazon-ssm-agent
KillMode=process
Restart=on-failure
RestartSec=15min
[Install]
WantedBy=network-online.target
EOF

systemctl enable amazon-ssm-agent.service


curl -o /opt/bin/meterctl https://s3.amazonaws.com/6fusion-meter-dev/coreos/<%= @version %>/meterctl
chmod +x /opt/bin/meterctl

END_USER_LICENSE_ACCEPTED=yes
/opt/bin/meterctl install-master -f $(curl http://instance-data/latest/meta-data/public-hostname) -P $(curl http://instance-data/latest/meta-data/public-ipv4) -p $(curl http://instance-data/latest/meta-data/local-ipv4)

echo begin kubeconfig

sudo sed -r 's|(^.+-authority): (.+)|printf "\1-data: %s" $(base64 -w0 \2)|e; s|(^.+-certificate: )(.+)|printf "    client-certificate-data: %s" $(base64 -w0 \2)|e;   s|(^ *client-key: )(.+)|printf "    client-key-data: %s" $(base64 -w0 \2)|e;'   /root/.kube/confi

echo end kubeconfig
